<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Resizable Square Webcam Recorder</title>
  <style>
    :root {
      --bg: #0b1220;
      --muted: #9aa4b2;
      --start-size: 320px;
    }
    html,body {
  height: 100%;
  margin: 0;
  font-family: system-ui, sans-serif;
  background: var(--bg);
  color: #fff;
  display: flex;
  flex-direction: column;
  align-items: stretch; /* important so header spans full width */
  justify-content: flex-start;
  padding: 0; /* optional, better header alignment */
}

    .card {
      width: 100%;
      max-width: 900px;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 6px 24px rgba(0,0,0,0.6);
      display: grid;
      gap: 10px;
        align-self: center; /* centers the webcam card */
    }
    .square {
      width: var(--start-size);
      height: var(--start-size);
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      display: grid;
      place-items: center;
      position: relative;

      /* allow user resize */
      resize: both;
      min-width: 200px;
      min-height: 200px;
      max-width: 95vw;
      max-height: 80vh;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(1);
      display: block;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: space-between;
    }
    button {
      background: #1f2937;
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
    }
    button.primary {
      background: #06b6d4;
      color: #022;
      font-weight: bold;
      border: none;
    }
    .status {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
      text-align: right;
    }
    .thumbnails {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .thumbnails img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
    }
    .recordings {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .recording {
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .recording video {
      width: 160px;
      border-radius: 6px;
    }
    .recording button {
      font-size: 12px;
      padding: 4px 8px;
    }
  </style>
</head>
<body>
  <div id="header-container" style="width:100%;"></div>
<script>
  fetch('/header.html')
    .then(res => res.text())
    .then(html => {
      document.getElementById('header-container').innerHTML = html;
      const header = document.querySelector('#header-container header');
      if (header) {
        header.style.width = "100%";
        header.style.boxSizing = "border-box";
        header.style.padding = "0.5rem 2rem";
        header.style.display = "flex";
        header.style.justifyContent = "space-between";
        header.style.alignItems = "center";
      }
    });
</script>

  <div class="card">
    <div class="square">
      <video id="webcamVideo" autoplay playsinline muted></video>
    </div>

    <div class="controls">
      <div style="display:flex; gap:6px;">
        <button id="startBtn" class="primary">Start Camera</button>
        <button id="stopBtn" disabled>Stop</button>
        <button id="recordBtn">Start Recording</button>
        <button id="clearAllBtn">Clear All Recordings</button>
      </div>
      <label>
        <input type="checkbox" id="mirrorToggle" /> Mirror
      </label>
    </div>

    <div class="status" id="statusText">No camera active</div>
    <div class="thumbnails" id="thumbnails"></div>
    <div class="recordings" id="recordings"></div>
  </div>

  <script>
    const videoEl = document.getElementById("webcamVideo");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const recordBtn = document.getElementById("recordBtn");
    const mirrorToggle = document.getElementById("mirrorToggle");
    const statusText = document.getElementById("statusText");
    const thumbnails = document.getElementById("thumbnails");
    const recordings = document.getElementById("recordings");
    const clearAllBtn = document.getElementById("clearAllBtn");

    let currentStream = null;
    let recorder = null;
    let recordedChunks = [];
    let isRecording = false;
    let thumbnailInterval = null;

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        currentStream = stream;
        videoEl.srcObject = stream;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        statusText.textContent = "Camera running";
      } catch (err) {
        console.error(err);
        statusText.textContent = "Camera error: " + err.message;
      }
    }

    function stopCamera() {
      if (currentStream) {
        currentStream.getTracks().forEach(t => t.stop());
        currentStream = null;
      }
      videoEl.srcObject = null;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      statusText.textContent = "No camera active";
    }

    function startRecording() {
      if (!currentStream) {
        alert("Start the camera first!");
        return;
      }
      recordedChunks = [];
      recorder = new MediaRecorder(currentStream, { mimeType: "video/webm; codecs=vp9" });
      recorder.ondataavailable = e => {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };
      recorder.onstop = saveRecording;
      recorder.start();
      isRecording = true;
      recordBtn.textContent = "Stop Recording";
      statusText.textContent = "Recording...";

      thumbnails.innerHTML = "";
      thumbnailInterval = setInterval(captureThumbnail, 3000); // every 3s
    }

    function stopRecording() {
      if (recorder && isRecording) {
        recorder.stop();
      }
      isRecording = false;
      recordBtn.textContent = "Start Recording";
      clearInterval(thumbnailInterval);
    }

    function saveRecording() {
      const blob = new Blob(recordedChunks, { type: "video/webm" });
      const url = URL.createObjectURL(blob);

      const container = document.createElement("div");
      container.className = "recording";

      const vid = document.createElement("video");
      vid.src = url;
      vid.controls = true;

      const download = document.createElement("a");
      download.href = url;
      download.download = `recording-${Date.now()}.webm`;
      download.textContent = "Download";

      const del = document.createElement("button");
      del.textContent = "Delete";
      del.onclick = () => container.remove();

      container.appendChild(vid);
      container.appendChild(download);
      container.appendChild(del);

      recordings.appendChild(container);

      statusText.textContent = "Recording finished";
    }

    function captureThumbnail() {
      const canvas = document.createElement("canvas");
      canvas.width = 60;
      canvas.height = 60;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);
      const img = document.createElement("img");
      img.src = canvas.toDataURL("image/png");
      thumbnails.appendChild(img);
    }

    startBtn.addEventListener("click", startCamera);
    stopBtn.addEventListener("click", stopCamera);
    recordBtn.addEventListener("click", () => {
      if (!isRecording) startRecording();
      else stopRecording();
    });
    mirrorToggle.addEventListener("change", () => {
      videoEl.style.transform = mirrorToggle.checked ? "scaleX(-1)" : "scaleX(1)";
    });
    clearAllBtn.addEventListener("click", () => {
      recordings.innerHTML = "";
    });
  </script>
</body>
</html>
